      PROGRAM MAIN
      IMPLICIT NONE
      INCLUDE 'fftw3.f'
      INTEGER :: K,KOBS,KREF,FPIXELS(3),LPIXELS(3),M,N,P,NFRAMES,INFO
     &  ,STATUS
      INTEGER*8 :: PLANF,PLANB
      DOUBLE PRECISION :: DTMP
      DOUBLE PRECISION, ALLOCATABLE :: DOBJ(:,:),DREF(:,:),DOBS(:,:)
      DOUBLE COMPLEX, ALLOCATABLE :: ZIN(:,:),ZOUT(:,:),ZOBJ(:,:)
      CHARACTER(LEN=256) :: ARG,FILEREF,PREFIX
      STATUS=0
      CALL GETARG(1,FILEREF)
      CALL GETARG(2,ARG)
      READ(ARG,*) FPIXELS(1),FPIXELS(2),FPIXELS(3)
      CALL GETARG(3,ARG)
      READ(ARG,*) LPIXELS(1),LPIXELS(2),LPIXELS(3)
      CALL GETARG(4,PREFIX)
      CALL DELETEFILE(TRIM(PREFIX)//'_OBJ.FITS',STATUS)
      CALL DELETEFILE(TRIM(PREFIX)//'_OBS.FITS',STATUS)
      CALL DELETEFILE(TRIM(PREFIX)//'_REF.FITS',STATUS)
      M=LPIXELS(1)-FPIXELS(1)+1
      N=LPIXELS(2)-FPIXELS(2)+1
      ALLOCATE(DOBJ(M,N))
      ALLOCATE(DREF(M,N))
      ALLOCATE(DOBS(M,N))
      NFRAMES=LPIXELS(3)-FPIXELS(3)+1
      P=MAX(M,N)
      DTMP=DEXP(CEILING(DLOG(DBLE(P))/DLOG(2.D0))*DLOG(2.D0))
      IF (DTMP-FLOOR(DTMP) .GE. 0.D5)THEN
        P=INT(FLOOR(DTMP)+1)
      ELSE
        P=INT(FLOOR(DTMP))
      END IF
      ALLOCATE(ZIN(P,P))
      ALLOCATE(ZOUT(P,P))
      ALLOCATE(ZOBJ(P,P))
      PRINT *,'Padding size: ',P
      CALL DFFTW_INIT_THREADS(INFO)
      IF (INFO .EQ. 0)THEN
        PRINT *,'DFFTW_INIT_THREADS failed.'
        RETURN
      END IF
      CALL DFFTW_PLAN_WITH_NTHREADS(2)
      CALL DFFTW_IMPORT_SYSTEM_WISDOM(INFO)
      IF (INFO .EQ. 0)THEN
        PRINT *,'DFFTW_IMPORT_SYSTEM_WISDOM failed.'
      END IF
      PRINT *,'Start planning.'
      CALL DFFTW_PLAN_DFT_2D(PLANF,P,P,ZIN,ZOUT,-1,
     &  FFTW_MEASURE+FFTW_DESTROY_INPUT)
      CALL DFFTW_PLAN_DFT_2D(PLANB,P,P,ZIN,ZOUT,1,
     &  FFTW_MEASURE+FFTW_DESTROY_INPUT)
      PRINT *,'Finished planning.'
C  Setup the source:
      DOBJ(1,1)=100.D0
      DOBJ(10,10)=50.D0
      CALL DFFTSHIFT(M,N,DOBJ)
      CALL WRITEIMAGE(TRIM(PREFIX)//'_OBJ.FITS',
     &  (/1,1,1/),(/M,N,1/),DOBJ)
      ZIN=CMPLX(0.D0)
      ZIN(1:M,1:N)=CMPLX(DOBJ)
      CALL DFFTW_EXECUTE_DFT(PLANF,ZIN,ZOUT)
      ZOBJ=ZOUT
      KOBS=0
      KREF=0
      DO K=1,NFRAMES
        CALL READIMAGE(FILEREF,(/FPIXELS(1),FPIXELS(2),K/),
     &    (/LPIXELS(1),LPIXELS(2),K/),DREF)
        DREF=DREF/SUM(DREF)
        IF (MOD(K,2) .EQ. 0)THEN
          KOBS=KOBS+1
          CALL DIFFTSHIFT(M,N,DREF)
          ZIN=CMPLX(0.D0)
          ZIN(1:M,1:N)=CMPLX(DREF)
          CALL DFFTW_EXECUTE_DFT(PLANF,ZIN,ZOUT)
          ZIN=ZOUT*ZOBJ
          CALL DFFTW_EXECUTE_DFT(PLANB,ZIN,ZOUT)
          DOBS=DREAL(ZOUT(1:M,1:N))/DBLE(M*N)
          CALL APPENDIMAGE(TRIM(PREFIX)//'_OBS.FITS',
     &      (/1,1,KOBS/),(/M,N,KOBS/),DOBS)
        ELSE
          KREF=KREF+1
          CALL APPENDIMAGE(TRIM(PREFIX)//'_REF.FITS',
     &      (/1,1,KREF/),(/M,N,KREF/),DREF)
        END IF
      END DO
      DEALLOCATE(ZIN)
      DEALLOCATE(ZOUT)
      DEALLOCATE(ZOBJ)
      DEALLOCATE(DOBS)
      DEALLOCATE(DREF)
      DEALLOCATE(DOBJ)
      STOP
      END PROGRAM MAIN